<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body{ font-family: Arial, sans-serif; padding:20px; margin:0; text-align:center; }
    input, button{ width:100%; padding:15px; font-size:18px; margin-top:10px; box-sizing:border-box; }
    button{ background:#2e7d32; color:white; border:none; border-radius:8px; }
    .subbtn{ background:#1565c0; }
    .danger{ background:#c62828; }
    .box{ margin-top:18px; padding-top:12px; border-top:1px solid #ddd; }
    #reader{ width:100%; margin-top:12px; }
    .small{ font-size:14px; color:#666; margin-top:6px; }
  </style>
</head>
<body>

<h2>ğŸ“¦ å•†å“ç™»éŒ²</h2>

<button class="subbtn" onclick="startScan()">ğŸ“· ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹</button>
<button class="danger" onclick="stopScan()">â›” ã‚¹ã‚­ãƒ£ãƒ³åœæ­¢</button>
<div class="small">â€»JANãŒèª­ã‚ãŸã‚‰è‡ªå‹•ã§æ¤œç´¢ã—ã¾ã™</div>
<div id="reader"></div>

<input id="input" placeholder="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰(JAN) or å•†å“åã§æ¤œç´¢">
<input id="qty" type="number" value="1" min="1">

<button onclick="search()">æ¤œç´¢</button>
<button onclick="registerTx('ä»•å…¥ã‚Œ')">ä»•å…¥ã‚Œ</button>
<button onclick="registerTx('å£²ä¸Š')">å£²ä¸Š</button>

<p id="result"></p>

<button onclick="toggleManual()">â• æ‰‹å‹•ã§å•†å“ç™»éŒ²</button>

<div id="manualBox" style="display:none;" class="box">
  <h3>æ–°è¦å•†å“ç™»éŒ²</h3>

  <input id="newName" placeholder="å•†å“å">
  <input id="newJan" placeholder="JANã‚³ãƒ¼ãƒ‰ï¼ˆã‚ã‚Œã°ï¼‰">
  <input id="newCost" type="number" inputmode="decimal" placeholder="ä»•å…¥å˜ä¾¡ï¼ˆä¾‹ï¼š120ï¼‰">

  <button class="subbtn" onclick="addNew()">å•†å“ãƒã‚¹ã‚¿ã«è¿½åŠ </button>
  <p id="addResult"></p>
</div>

<script>
  // ======= â˜…ã“ã“ã ã‘å¿…ãšè¨­å®š =======
  const API_URL = "https://script.google.com/macros/s/AKfycbz_s9F7r_BuOzAHT8-2LcKBe4MzqvZmAsiF7ojscWNSndoKSHnXFsem50Qsqyszkf9N/exec";
  // =================================

  let currentProduct = null;

  // ======= APIå‘¼ã³å‡ºã—ï¼ˆå…±é€šï¼‰ =======
  async function api(payload){
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    return await res.json();
  }

  // ======= ã‚«ãƒ¡ãƒ© =======
  let scanner = null;
  let scanning = false;
  let scanLock = false;

  async function startScan(){
    if (scanning) return;
    scanning = true;
    scanLock = false;

    try{
      const cameras = await Html5Qrcode.getCameras();
      if (!cameras || cameras.length === 0) {
        alert("ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
        scanning = false;
        return;
      }

      const back = cameras.find(c =>
        (c.label || "").toLowerCase().includes("back") ||
        (c.label || "").toLowerCase().includes("rear")
      );
      const cameraId = (back ? back.id : cameras[cameras.length - 1].id);

      scanner = new Html5Qrcode("reader");

      await scanner.start(
        cameraId,
        {
          fps: 12,
          qrbox: { width: 360, height: 220 },
          disableFlip: true
        },
        (decodedText) => {
          if (scanLock) return;
          scanLock = true;

          document.getElementById("input").value = decodedText;
          search().finally(() => {
            stopScan();
            scanLock = false;
          });
        }
      );

    } catch(e){
      alert("ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹ã‚¨ãƒ©ãƒ¼: " + (e && e.message ? e.message : String(e)));
      scanning = false;
    }
  }

  async function stopScan(){
    scanning = false;
    if (!scanner) return;
    try { await scanner.stop(); } catch(e) {}
    try { await scanner.clear(); } catch(e) {}
    scanner = null;
  }

  // ======= æ¤œç´¢ =======
  async function search() {
    const input = document.getElementById("input").value.trim();
    if(!input){
      document.getElementById("result").innerText = "";
      currentProduct = null;
      return;
    }

    try{
      const res = await api({ action: "searchProduct", query: input });

      if(res && res.found){
        currentProduct = res;
        document.getElementById("result").innerText =
          "âœ… å•†å“: " + res.name + "ï¼ˆ" + res.id + "ï¼‰";
      } else {
        currentProduct = null;
        document.getElementById("result").innerText =
          "âŒ å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆæ‰‹å‹•ç™»éŒ²ã§ãã¾ã™ï¼‰";
      }
    } catch(err){
      alert("æ¤œç´¢ã‚¨ãƒ©ãƒ¼: " + err);
    }
  }

  // ======= ä»•å…¥/å£²ä¸Š ç™»éŒ² =======
  async function registerTx(type){
    if(!currentProduct){
      alert("å…ˆã«å•†å“ã‚’æ¤œç´¢ã—ã¦ãã ã•ã„ï¼ˆè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯æ‰‹å‹•ç™»éŒ²ï¼‰");
      return;
    }
    const qty = Number(document.getElementById("qty").value) || 0;
    if(qty <= 0){
      alert("æ•°é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      return;
    }

    try{
      const action = (type === "ä»•å…¥ã‚Œ") ? "addBuy" : "addSale";
      const res = await api({ action, productId: currentProduct.id, qty });

      alert(res && res.message ? res.message : "ç™»éŒ²ã—ã¾ã—ãŸ");

      // å…¥åŠ›ã‚¯ãƒªã‚¢
      document.getElementById("qty").value = 1;
      document.getElementById("input").value = "";
      document.getElementById("result").innerText = "";
      currentProduct = null;

    } catch(err){
      alert("ç™»éŒ²ã‚¨ãƒ©ãƒ¼: " + err);
    }
  }

  // ======= æ‰‹å‹•ç™»éŒ²ã®é–‹é–‰ =======
  function toggleManual(){
    const box = document.getElementById("manualBox");
    box.style.display = (box.style.display === "none") ? "block" : "none";
  }

  // ======= æ–°è¦è¿½åŠ  =======
  async function addNew(){
    const name = document.getElementById("newName").value.trim();
    const jan  = document.getElementById("newJan").value.trim();
    const cost = Number(document.getElementById("newCost").value) || 0;

    if(!name){
      alert("å•†å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      return;
    }

    try{
      const res = await api({ action: "addNewProduct", name, jan, cost });

      if(res && res.ok){
        document.getElementById("addResult").innerText =
          "âœ… è¿½åŠ ã—ã¾ã—ãŸ: " + res.name + "ï¼ˆ" + res.id + "ï¼‰";

        // è¿½åŠ ã—ãŸå•†å“ã‚’é¸æŠçŠ¶æ…‹ã«
        currentProduct = { id: res.id, name: res.name };
        document.getElementById("result").innerText =
          "âœ… å•†å“: " + res.name + "ï¼ˆ" + res.id + "ï¼‰";

        // å…¥åŠ›ã‚¯ãƒªã‚¢ã—ã¦é–‰ã˜ã‚‹
        document.getElementById("newName").value = "";
        document.getElementById("newJan").value = "";
        document.getElementById("newCost").value = "";
        toggleManual();

      } else {
        document.getElementById("addResult").innerText =
          "âš  " + (res && res.message ? res.message : "è¿½åŠ ã§ãã¾ã›ã‚“ã§ã—ãŸ");
      }
    } catch(err){
      alert("è¿½åŠ ã‚¨ãƒ©ãƒ¼: " + err);
    }
  }
</script>

</body>
</html>
