<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body{ font-family: Arial, sans-serif; padding:20px; margin:0; text-align:center; }
    input, button{ width:100%; padding:15px; font-size:18px; margin-top:10px; box-sizing:border-box; }
    button{ background:#2e7d32; color:white; border:none; border-radius:8px; }
    .subbtn{ background:#1565c0; }
    .danger{ background:#c62828; }
    .box{ margin-top:18px; padding-top:12px; border-top:1px solid #ddd; }
    #reader{ width:100%;
             max-width:420px;
             margin:12px auto 0; }
    .small{ font-size:14px; color:#666; margin-top:6px; }
  </style>
</head>
<body>

<h2>ğŸ“¦ å•†å“ç™»éŒ²</h2>

<!-- âœ… ã‚«ãƒ¡ãƒ©èª­ã¿å–ã‚Š -->
<button class="subbtn" onclick="startScan()">ğŸ“· ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹</button>
<button class="danger" onclick="stopScan()">â›” ã‚¹ã‚­ãƒ£ãƒ³åœæ­¢</button>
<div class="small">â€»ã‚«ãƒ¡ãƒ©è¨±å¯ãŒå‡ºãŸã‚‰ã€Œè¨±å¯ã€ã€‚JANãŒèª­ã‚ãŸã‚‰è‡ªå‹•ã§æ¤œç´¢ã—ã¾ã™ã€‚</div>
<div id="reader"></div>

<input id="input" placeholder="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰(JAN) or å•†å“åã§æ¤œç´¢">
<input id="qty" type="number" value="1" min="1">

<button onclick="search()">æ¤œç´¢</button>
<button onclick="registerTx('ä»•å…¥')">ä»•å…¥ã‚Œ</button>
<button onclick="registerTx('å£²ä¸Š')">å£²ä¸Š</button>

<p id="result"></p>

<button onclick="toggleManual()">â• æ‰‹å‹•ã§å•†å“ç™»éŒ²</button>

<div id="manualBox" style="display:none;" class="box">

  <h3>æ–°è¦å•†å“ç™»éŒ²</h3>

  <input id="newName" placeholder="å•†å“å">
  <input id="newJan" placeholder="JANã‚³ãƒ¼ãƒ‰">
  <input id="newCost" placeholder="ä»•å…¥å˜ä¾¡">

  <button class="subbtn" onclick="addNew()">å•†å“ãƒã‚¹ã‚¿ã«è¿½åŠ </button>

  <p id="addResult"></p>

</div>

<script>
  let currentProduct = null;

  // ===== ã‚«ãƒ¡ãƒ© =====
  let scanner = null;
let scanning = false;
let scanLock = false;   // â† è¿½åŠ ï¼šèª­ã¿å–ã£ãŸç¬é–“ã«ãƒ­ãƒƒã‚¯ã—ã¦æ­¢ã‚ã‚‹

async function startScan(){
  if (scanning) return;
  scanning = true;
  scanLock = false;

  try{
    const cameras = await Html5Qrcode.getCameras();
    if (!cameras || cameras.length === 0) {
      alert("ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
      scanning = false;
      return;
    }

    const back = cameras.find(c =>
      (c.label || "").toLowerCase().includes("back") ||
      (c.label || "").toLowerCase().includes("rear")
    );
    const cameraId = (back ? back.id : cameras[cameras.length - 1].id);

    scanner = new Html5Qrcode("reader");

    await scanner.start(
      cameraId,
      {
        fps: 12,
        // âœ… JANã¯æ¨ªé•·ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ãªã®ã§æ ã‚’å¤§ãã‚ï¼†é«˜ã•ã‚‚ç¢ºä¿
        qrbox: { width: 360, height: 220 },
        // âœ… åè»¢åˆ¤å®šã‚’åˆ‡ã£ã¦ç„¡é§„ãªæ¢ç´¢ã‚’æ¸›ã‚‰ã™ï¼ˆãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã«ã¯åŸºæœ¬ä¸è¦ï¼‰
        disableFlip: true,
        // âœ… ç«¯æœ«ãŒå¯¾å¿œã—ã¦ãŸã‚‰é«˜é€Ÿãªæ¤œå‡ºå™¨ã‚’ä½¿ã†ï¼ˆå¯¾å¿œã—ã¦ãªã„å ´åˆã¯ç„¡è¦–ã•ã‚Œã‚‹ï¼‰
        experimentalFeatures: { useBarCodeDetectorIfSupported: true }
      },
      (decodedText) => {
        // âœ… é€£ç¶šç™ºç«é˜²æ­¢
        if (scanLock) return;
        scanLock = true;

        document.getElementById("input").value = decodedText;

        // æ¤œç´¢ã‚’èµ°ã‚‰ã›ã‚‹ï¼ˆã“ã“ã¯ãã®ã¾ã¾ã§OKï¼‰
        search();

        // âœ… ã¡ã‚ƒã‚“ã¨åœæ­¢ï¼ˆPromiseå¾…ã¡ã¯ã“ã“ã§ã¯ã§ããªã„ã®ã§ then ã§ï¼‰
        stopScan().catch(() => {}).finally(() => {
          // å¿µã®ãŸã‚è§£é™¤ï¼ˆæ¬¡å›ã‚¹ã‚­ãƒ£ãƒ³ã®ãŸã‚ï¼‰
          scanLock = false;
        });
      }
    );

  } catch(e){
    alert("ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹ã‚¨ãƒ©ãƒ¼: " + (e && e.message ? e.message : String(e)));
    scanning = false;
  }
}

async function stopScan(){
  // å…ˆã«ãƒ•ãƒ©ã‚°ã‚’è½ã¨ã—ã¦ â€œæ­¢ã‚ãŸã„æ„å¿—â€ ã‚’å›ºå®š
  scanning = false;

  if (!scanner) return;

  try { await scanner.stop(); } catch(e) {}
  try { await scanner.clear(); } catch(e) {}

  scanner = null;
}

  // ===== æ¤œç´¢ =====
  function search() {
    const input = document.getElementById("input").value;

    google.script.run.withSuccessHandler(function(res){
      if(res){
        currentProduct = res;
        document.getElementById("result").innerText =
          "âœ… å•†å“: " + res.name + "ï¼ˆ" + res.id + "ï¼‰";
      } else {
        currentProduct = null;
        document.getElementById("result").innerText =
          "âŒ å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆæ‰‹å‹•ç™»éŒ²ã‚’ä½¿ã£ã¦ãã ã•ã„ï¼‰";
      }
    }).withFailureHandler(function(err){
      alert("æ¤œç´¢ã‚¨ãƒ©ãƒ¼: " + err.message);
    }).searchProduct(input);
  }

  // ===== ç™»éŒ² =====
  function registerTx(type){
    if(!currentProduct){
      alert("å…ˆã«å•†å“ã‚’æ¤œç´¢ã—ã¦ãã ã•ã„ï¼ˆè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯æ‰‹å‹•ç™»éŒ²ï¼‰");
      return;
    }
    const qty = document.getElementById("qty").value;

    google.script.run.withSuccessHandler(function(msg){
      alert(msg);
      document.getElementById("qty").value = 1;
      document.getElementById("input").value = "";
      currentProduct = null;
      document.getElementById("result").innerText = "";
    }).withFailureHandler(function(err){
      alert("ç™»éŒ²ã‚¨ãƒ©ãƒ¼: " + err.message);
    }).registerTransaction(type, currentProduct.id, qty);
  }

  // ===== æ‰‹å‹•ç™»éŒ²ã®é–‹é–‰ =====
  function toggleManual(){
    const box = document.getElementById("manualBox");
    box.style.display = (box.style.display === "none") ? "block" : "none";
  }

  // ===== æ–°è¦è¿½åŠ  =====
  function addNew(){
    const name = document.getElementById("newName").value;
    const jan  = document.getElementById("newJan").value;
    const cost = document.getElementById("newCost").value;

    google.script.run.withSuccessHandler(function(res){
      if(res.ok){
        document.getElementById("addResult").innerText =
          "âœ… è¿½åŠ ã—ã¾ã—ãŸ: " + res.name + "ï¼ˆ" + res.id + "ï¼‰";

        // è¿½åŠ ã—ãŸå•†å“ã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
        currentProduct = { id: res.id, name: res.name };
        document.getElementById("result").innerText =
          "âœ… å•†å“: " + res.name + "ï¼ˆ" + res.id + "ï¼‰";

        // âœ… å…¥åŠ›ã‚¯ãƒªã‚¢ã—ã¦é–‰ã˜ã‚‹
        document.getElementById("newName").value = "";
        document.getElementById("newJan").value = "";
        document.getElementById("newCost").value = "";
        toggleManual();

      } else {
        document.getElementById("addResult").innerText = "âš  " + res.message;
      }
    }).withFailureHandler(function(err){
      alert("è¿½åŠ ã‚¨ãƒ©ãƒ¼: " + err.message);
    }).addNewProduct(name, jan, cost);
  }
</script>

</body>
</html>
