<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body{ font-family: Arial, sans-serif; padding:20px; margin:0; text-align:center; }
    input, button{ width:100%; padding:15px; font-size:18px; margin-top:10px; box-sizing:border-box; }
    button{ background:#2e7d32; color:white; border:none; border-radius:8px; }
    .subbtn{ background:#1565c0; }
    .danger{ background:#c62828; }
    .box{ margin-top:18px; padding-top:12px; border-top:1px solid #ddd; }
    #reader{ width:100%;
             max-width:420px;
             margin:12px auto 0; }
    .small{ font-size:14px; color:#666; margin-top:6px; }
  </style>
</head>
<body>

<h2>ğŸ“¦ å•†å“ç™»éŒ²</h2>

<!-- âœ… ã‚«ãƒ¡ãƒ©èª­ã¿å–ã‚Š -->
<button class="subbtn" onclick="startScan()">ğŸ“· ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹</button>
<button class="danger" onclick="stopScan()">â›” ã‚¹ã‚­ãƒ£ãƒ³åœæ­¢</button>
<div class="small">â€»ã‚«ãƒ¡ãƒ©è¨±å¯ãŒå‡ºãŸã‚‰ã€Œè¨±å¯ã€ã€‚JANãŒèª­ã‚ãŸã‚‰è‡ªå‹•ã§æ¤œç´¢ã—ã¾ã™ã€‚</div>
<div id="reader"></div>

<input id="input" placeholder="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰(JAN) or å•†å“åã§æ¤œç´¢">
<input id="qty" type="number" value="1" min="1">

<button onclick="search()">æ¤œç´¢</button>
<button onclick="registerTx('ä»•å…¥')">ä»•å…¥ã‚Œ</button>
<button onclick="registerTx('å£²ä¸Š')">å£²ä¸Š</button>

<p id="result"></p>

<button onclick="toggleManual()">â• æ‰‹å‹•ã§å•†å“ç™»éŒ²</button>

<div id="manualBox" style="display:none;" class="box">

  <h3>æ–°è¦å•†å“ç™»éŒ²</h3>

  <input id="newName" placeholder="å•†å“å">
  <input id="newJan" placeholder="JANã‚³ãƒ¼ãƒ‰">
  <input id="newCost" placeholder="ä»•å…¥å˜ä¾¡">

  <button class="subbtn" onclick="addNew()">å•†å“ãƒã‚¹ã‚¿ã«è¿½åŠ </button>

  <p id="addResult"></p>

</div>

<script>

let scanner = null;
let scanning = false;

async function startScan(){

  if (scanning) return;

  scanning = true;

  try{

    const cameras = await Html5Qrcode.getCameras();

    if (!cameras.length){
      alert("ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
      scanning = false;
      return;
    }

    const cameraId = cameras[cameras.length - 1].id;

    scanner = new Html5Qrcode("reader");

    await scanner.start(
      cameraId,
      {
        fps: 15,
        qrbox: 250
      },
      (decodedText)=>{

        document.getElementById("input").value = decodedText;

        search();

        stopScan();

      }
    );

  }catch(e){

    alert("ã‚¨ãƒ©ãƒ¼ï¼š" + e);

    scanning = false;

  }

}


async function stopScan(){

  if(!scanner) return;

  await scanner.stop();

  await scanner.clear();

  scanner = null;

  scanning = false;

}

</script>

</body>
</html>
