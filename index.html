<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body{ font-family: Arial, sans-serif; padding:20px; margin:0; text-align:center; }
    input, button{ width:100%; padding:15px; font-size:18px; margin-top:10px; box-sizing:border-box; }
    button{ background:#2e7d32; color:white; border:none; border-radius:8px; }
    .subbtn{ background:#1565c0; }
    .danger{ background:#c62828; }
    .box{ margin-top:18px; padding-top:12px; border-top:1px solid #ddd; }
    .small{ font-size:14px; color:#666; margin-top:6px; }

    /* readerã¯ã‚µã‚¤ã‚ºå›ºå®šï¼ˆæ˜ åƒãŒUIã‚’è¦†ã‚ãªã„ï¼‰ */
    #reader{
      width:100%;
      max-width:460px;
      height:240px;
      margin:12px auto;
      overflow:hidden;
      border:3px solid red;   /* â†ç¢ºèªç”¨ï¼ˆæ…£ã‚ŒãŸã‚‰æ¶ˆã—ã¦OKï¼‰ */
      border-radius:12px;
      position: relative;
      z-index: 1;
    }
    #reader video{
      width:100% !important;
      height:240px !important;
      object-fit:cover !important;
      pointer-events:none !important;
    }

    /* UIã¯æœ€å‰é¢ */
    #ui{
      position: relative;
      z-index: 9999;
    }
  </style>
</head>
<body>

<h2>ğŸ“¦ å•†å“ç™»éŒ²</h2>

<!-- ã‚«ãƒ¡ãƒ© -->
<button class="subbtn" onclick="startScan()">ğŸ“· ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹</button>
<button class="danger" onclick="stopScan()">â›” ã‚¹ã‚­ãƒ£ãƒ³åœæ­¢</button>
<div class="small">â€»JANãŒèª­ã‚ãŸã‚‰è‡ªå‹•ã§æ¤œç´¢ã—ã¾ã™</div>
<div id="reader"></div>

<!-- UI -->
<div id="ui">

  <input id="input" placeholder="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰(JAN) or å•†å“åã§æ¤œç´¢">
  <input id="qty" type="number" value="1" min="1">

  <button onclick="search()">æ¤œç´¢</button>
  <button onclick="registerTx('ä»•å…¥ã‚Œ')">ä»•å…¥ã‚Œ</button>
  <button onclick="registerTx('å£²ä¸Š')">å£²ä¸Š</button>

  <p id="result"></p>

  <button onclick="toggleManual()">â• æ‰‹å‹•ã§å•†å“ç™»éŒ²</button>

  <div id="manualBox" style="display:none;" class="box">
    <h3>æ–°è¦å•†å“ç™»éŒ²</h3>
    <input id="newName" placeholder="å•†å“å">
    <input id="newJan" placeholder="JANã‚³ãƒ¼ãƒ‰ï¼ˆã‚ã‚Œã°ï¼‰">
    <input id="newCost" type="number" inputmode="decimal" placeholder="ä»•å…¥å˜ä¾¡ï¼ˆä¾‹ï¼š120ï¼‰">
    <button class="subbtn" onclick="addNew()">å•†å“ãƒã‚¹ã‚¿ã«è¿½åŠ </button>
    <p id="addResult"></p>
  </div>

</div>

<script>
  // âœ… ã‚ãªãŸã®GAS /execï¼ˆJSONPå¯¾å¿œã® doGet ãŒå…¥ã£ã¦ã‚‹URLï¼‰
  const API_URL = "https://script.google.com/macros/s/AKfycbxUY_9TR9Wu-urdCBvEv2aKQza2mPlVHOcZA6h5iHqTUDEtiUG5qYjTooMkAy2S0npr/exec";

  // çŠ¶æ…‹
  let currentProduct = null;

  // ã‚«ãƒ¡ãƒ©
  let scanner = null;

  // ===== JSONP API =====
  function apiJsonp(params){
    return new Promise((resolve, reject) => {
      const cb = "cb_" + Date.now() + "_" + Math.floor(Math.random()*1e6);
      const qs = new URLSearchParams({ ...params, callback: cb, t: Date.now() }).toString();
      const url = API_URL + "?" + qs;

      const s = document.createElement("script");

      window[cb] = (res) => {
        cleanup();
        resolve(res);
      };

      s.onerror = () => {
        cleanup();
        reject(new Error("Load failed (jsonp)"));
      };

      s.src = url;
      document.body.appendChild(s);

      function cleanup(){
        try{ delete window[cb]; }catch(e){}
        try{ s.remove(); }catch(e){}
      }
    });
  }

  // ===== ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹ï¼ˆJANå‘ã‘ï¼‰=====
  async function startScan(){
  try{
    if (scanner) return;

    scanner = new Html5Qrcode("reader");

    await scanner.start(
      { facingMode: "environment" },
      {
        fps: 15,
        qrbox: { width: 320, height: 160 },
        aspectRatio: 1.777,
        disableFlip: true,

        // âœ… JANç³»ã‚’æ˜ç¤ºï¼ˆã“ã‚ŒãŒé‡è¦ï¼‰
        formatsToSupport: [
          Html5QrcodeSupportedFormats.EAN_13,
          Html5QrcodeSupportedFormats.EAN_8,
          Html5QrcodeSupportedFormats.UPC_A,
          Html5QrcodeSupportedFormats.UPC_E,
          Html5QrcodeSupportedFormats.CODE_128
        ],

        // âœ… ç«¯æœ«ã«ã‚ˆã£ã¦åŠ¹ãï¼ˆåŠ¹ã‹ãªãã¦ã‚‚OKï¼‰
        experimentalFeatures: {
          useBarCodeDetectorIfSupported: true
        }
      },
      async (decodedText) => {
        document.getElementById("input").value = decodedText;
        await search();
        await stopScan();
      }
    );
  }catch(e){
    alert("ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹ã‚¨ãƒ©ãƒ¼: " + (e && e.message ? e.message : String(e)));
    scanner = null;
  }
}

  async function stopScan(){
    try{
      if (!scanner) return;
      await scanner.stop();
      await scanner.clear();
    } catch(e) {
      // stopå¤±æ•—ã—ã¦ã‚‚OK
    } finally {
      scanner = null;
    }
  }

  // ===== æ¤œç´¢ =====
  async function search(){

  const q = document.getElementById("input").value.trim();

  if(!q){
    return;
  }

  const res = await apiJsonp({
    action:"searchProduct",
    query:q
  });

  if(res.found){

    currentProduct = res;

    document.getElementById("result").innerText =
      `âœ… å•†å“: ${res.name}ï¼ˆ${res.id}ï¼‰`;

  }else{

    currentProduct = null;

    document.getElementById("result").innerText =
      "âŒ å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“";

    // â­ã“ã“ãŒè¿½åŠ ãƒã‚¤ãƒ³ãƒˆ
    document.getElementById("manualBox").style.display = "block";

    // â­JANã‚’è‡ªå‹•å…¥åŠ›
    document.getElementById("newJan").value = q;

  }

}

  // ===== ä»•å…¥ / å£²ä¸Š ç™»éŒ² =====
  async function registerTx(type){
    try{
      if(!currentProduct){
        alert("å…ˆã«å•†å“ã‚’æ¤œç´¢ã—ã¦ãã ã•ã„");
        return;
      }

      const qty = Number(document.getElementById("qty").value) || 0;
      if(qty <= 0){
        alert("æ•°é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
      }

      const action = (type === "ä»•å…¥ã‚Œ") ? "addBuy" : "addSale";
      const res = await apiJsonp({ action, productId: currentProduct.id, qty });

      alert(res && res.message ? res.message : "ç™»éŒ²ã—ã¾ã—ãŸ");

      // å…¥åŠ›ã‚¯ãƒªã‚¢
      document.getElementById("qty").value = 1;
      document.getElementById("input").value = "";
      document.getElementById("result").innerText = "";
      currentProduct = null;

    }catch(e){
      alert("ç™»éŒ²ã‚¨ãƒ©ãƒ¼: " + (e && e.message ? e.message : String(e)));
    }
  }

  // ===== æ‰‹å‹•ç™»éŒ²ã®é–‹é–‰ =====
  function toggleManual(){
    const box = document.getElementById("manualBox");
    box.style.display = (box.style.display === "none") ? "block" : "none";
  }

  // ===== æ–°è¦è¿½åŠ ï¼ˆâ€»GASå´ã« addNewProduct ãŒå¿…è¦ï¼‰=====
  async function addNew(){
    try{
      const name = document.getElementById("newName").value.trim();
      const jan  = document.getElementById("newJan").value.trim();
      const cost = Number(document.getElementById("newCost").value) || 0;

      if(!name){
        alert("å•†å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
      }

      // GASå´ã« addNewProduct ã‚’å®Ÿè£…ã—ã¦ã‚ã‚‹å‰æ
      const res = await apiJsonp({ action:"addNewProduct", name, jan, cost });

      if(res && res.ok){
        document.getElementById("addResult").innerText = `âœ… è¿½åŠ ã—ã¾ã—ãŸ: ${res.name}ï¼ˆ${res.id}ï¼‰`;
        document.getElementById("input").value = res.id;
search();
        currentProduct = { id: res.id, name: res.name };
        document.getElementById("result").innerText = `âœ… å•†å“: ${res.name}ï¼ˆ${res.id}ï¼‰`;

        // å…¥åŠ›ã‚¯ãƒªã‚¢ã—ã¦é–‰ã˜ã‚‹
        document.getElementById("newName").value = "";
        document.getElementById("newJan").value = "";
        document.getElementById("newCost").value = "";
        toggleManual();
      } else {
        document.getElementById("addResult").innerText = "âš  " + (res && res.message ? res.message : "è¿½åŠ ã§ãã¾ã›ã‚“ã§ã—ãŸ");
      }

    }catch(e){
      alert("è¿½åŠ ã‚¨ãƒ©ãƒ¼: " + (e && e.message ? e.message : String(e)));
    }
  }

  // ã‚°ãƒ­ãƒ¼ãƒãƒ«ï¼ˆiPhone Safariå®‰å®šï¼‰
  window.startScan = startScan;
  window.stopScan = stopScan;
  window.search = search;
  window.registerTx = registerTx;
  window.toggleManual = toggleManual;
  window.addNew = addNew;

  // URLã« ?jan=123... ãŒä»˜ã„ã¦ãŸã‚‰è‡ªå‹•ã§å…¥åŠ›â†’æ¤œç´¢
window.addEventListener("load", () => {
  const p = new URLSearchParams(location.search);
  const jan = p.get("jan");
  if (jan) {
    document.getElementById("input").value = jan;
    // å°‘ã—å¾…ã£ã¦ã‹ã‚‰æ¤œç´¢ï¼ˆiPhoneã§å®‰å®šï¼‰
    setTimeout(() => { window.search && window.search(); }, 200);
  }
});
</script>

</body>
</html>
