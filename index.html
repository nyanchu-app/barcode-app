<!DOCTYPE html>
<html>

<head>

<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://unpkg.com/html5-qrcode"></script>

<style>

body{
 font-family: Arial, sans-serif;
 padding:20px;
 margin:0;
 text-align:center;
}

input, button{
 width:100%;
 padding:15px;
 font-size:18px;
 margin-top:10px;
 box-sizing:border-box;
}

button{
 background:#2e7d32;
 color:white;
 border:none;
 border-radius:8px;
}

.subbtn{
 background:#1565c0;
}

.danger{
 background:#c62828;
}

.box{
 margin-top:18px;
 padding-top:12px;
 border-top:1px solid #ddd;
}

#reader{
 width:100%;
 margin-top:12px;
}

.small{
 font-size:14px;
 color:#666;
 margin-top:6px;
}

</style>

</head>


<body>

<h2>ğŸ“¦ å•†å“ç™»éŒ²</h2>


<button class="subbtn" onclick="startScan()">ğŸ“· ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹</button>

<button class="danger" onclick="stopScan()">â›” ã‚¹ã‚­ãƒ£ãƒ³åœæ­¢</button>

<div class="small">
â€»JANã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚‹ã¨è‡ªå‹•æ¤œç´¢ã•ã‚Œã¾ã™
</div>

<div id="reader"></div>



<input id="input" placeholder="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰(JAN) or å•†å“å">

<input id="qty" type="number" value="1">



<button onclick="search()">æ¤œç´¢</button>

<button onclick="registerTx('ä»•å…¥')">ä»•å…¥ã‚Œ</button>

<button onclick="registerTx('å£²ä¸Š')">å£²ä¸Š</button>



<p id="result"></p>



<button onclick="toggleManual()">â• æ‰‹å‹•ã§å•†å“ç™»éŒ²</button>



<div id="manualBox" style="display:none;" class="box">

<h3>æ–°è¦å•†å“ç™»éŒ²</h3>

<input id="newName" placeholder="å•†å“å">

<input id="newJan" placeholder="JANã‚³ãƒ¼ãƒ‰">

<input id="newCost" placeholder="ä»•å…¥å˜ä¾¡">

<button class="subbtn" onclick="addNew()">
å•†å“ãƒã‚¹ã‚¿ã«è¿½åŠ 
</button>

<p id="addResult"></p>

</div>



<script>


let currentProduct = null;

let scanner = null;

let scanning = false;



async function startScan(){

 if(scanning) return;

 scanning = true;

 try{

  const cameras = await Html5Qrcode.getCameras();

  if(!cameras.length){

   alert("ã‚«ãƒ¡ãƒ©ãªã—");

   scanning=false;

   return;

  }


  const cameraId = cameras[cameras.length - 1].id;


  scanner = new Html5Qrcode("reader");


  await scanner.start(

   cameraId,

   {

    fps:15,

    qrbox:250

   },


   (decodedText)=>{

    document.getElementById("input").value = decodedText;

    search();

    stopScan();

   }

  );


 }catch(e){

  alert("ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼ï¼š"+e);

  scanning=false;

 }

}



async function stopScan(){

 if(!scanner) return;

 await scanner.stop();

 await scanner.clear();

 scanner=null;

 scanning=false;

}



function search(){

 const input = document.getElementById("input").value;


 google.script.run

 .withSuccessHandler(function(res){

  if(res){

   currentProduct=res;

   document.getElementById("result").innerText=

   "âœ… "+res.name;

  }else{

   currentProduct=null;

   document.getElementById("result").innerText=

   "âŒ å•†å“ãªã—";

  }

 })

 .searchProduct(input);


}



function registerTx(type){

 if(!currentProduct){

  alert("å•†å“ã‚’æ¤œç´¢ã—ã¦");

  return;

 }


 const qty = document.getElementById("qty").value;


 google.script.run

 .withSuccessHandler(function(msg){

  alert(msg);

 })

 .registerTransaction(

  type,

  currentProduct.id,

  qty

 );


}



function toggleManual(){

 const box = document.getElementById("manualBox");

 box.style.display =

 box.style.display==="none"

 ?

 "block"

 :

 "none";

}



function addNew(){

 const name = document.getElementById("newName").value;

 const jan = document.getElementById("newJan").value;

 const cost = document.getElementById("newCost").value;



 google.script.run

 .withSuccessHandler(function(res){

  alert("è¿½åŠ å®Œäº†");

 })

 .addNewProduct(

  name,

  jan,

  cost

 );

}



</script>



</body>

</html>
