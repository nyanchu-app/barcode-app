<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
  body{ font-family: Arial, sans-serif; padding:20px; margin:0; text-align:center; }
  input, button{ width:100%; padding:15px; font-size:18px; margin-top:10px; box-sizing:border-box; }
  button{ background:#2e7d32; color:white; border:none; border-radius:8px; }
  .subbtn{ background:#1565c0; }
  .danger{ background:#c62828; }
  .box{ margin-top:18px; padding-top:12px; border-top:1px solid #ddd; }
  #reader{ width:100%; max-width:460px; margin:12px auto; }
  .small{ font-size:14px; color:#666; margin-top:6px; }

  /* ===== ã“ã“ã‹ã‚‰è¿½åŠ  ===== */

  /* â‘  readerã¯èƒŒé¢ */
  #reader{
    position: relative;
    z-index: 1;
  }

  /* â‘¡ UIã¯æœ€å‰é¢ */
  #ui{
    position: relative;
    z-index: 9999;
  }

  /* â‘¢ readerãŒã‚¿ãƒƒãƒ—ã‚’å¸ã‚ãªã„ã‚ˆã†ã«ã™ã‚‹ */
  #reader, #reader *{
    pointer-events: none !important;
  }

</style>
</head>
<body>

<h2>ğŸ“¦ å•†å“ç™»éŒ²</h2>

<button class="subbtn" onclick="startScan()">ğŸ“· ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹</button>
<button class="danger" onclick="stopScan()">â›” ã‚¹ã‚­ãƒ£ãƒ³åœæ­¢</button>
<div class="small">â€»JANãŒèª­ã‚ãŸã‚‰è‡ªå‹•ã§æ¤œç´¢ã—ã¾ã™</div>
<div id="reader" style="
width:320px;
height:200px;
margin:20px auto;
border:3px solid red;
"></div>

<div id="ui">
<input id="input" placeholder="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰(JAN) or å•†å“åã§æ¤œç´¢">
<input id="qty" type="number" value="1" min="1">

<button onclick="alert('æŠ¼ã›ãŸ'); search()">æ¤œç´¢</button>
<button onclick="registerTx('ä»•å…¥ã‚Œ')">ä»•å…¥ã‚Œ</button>
<button onclick="registerTx('å£²ä¸Š')">å£²ä¸Š</button>

<p id="result"></p>

<button onclick="toggleManual()">â• æ‰‹å‹•ã§å•†å“ç™»éŒ²</button>

<div id="manualBox" style="display:none;" class="box">
  <h3>æ–°è¦å•†å“ç™»éŒ²</h3>
  <input id="newName" placeholder="å•†å“å">
  <input id="newJan" placeholder="JANã‚³ãƒ¼ãƒ‰ï¼ˆã‚ã‚Œã°ï¼‰">
  <input id="newCost" type="number" inputmode="decimal" placeholder="ä»•å…¥å˜ä¾¡ï¼ˆä¾‹ï¼š120ï¼‰">
  <button class="subbtn" onclick="addNew()">å•†å“ãƒã‚¹ã‚¿ã«è¿½åŠ </button>
  <p id="addResult"></p>
</div>
</div>

<script>
  // ======= â˜…ã“ã“ã ã‘å¿…ãšè¨­å®š =======
  const API_URL = "https://script.google.com/macros/s/AKfycbyQJXrk21DJTKYpkcEnuh6ioiMkVjG05A4UKNn06JokZHMffHLCdE9StEy_KZO3S1no/exec";
  // =================================

  // ç”»é¢ã§ä½¿ã†çŠ¶æ…‹
  let currentProduct = null;

  // ã‚«ãƒ¡ãƒ©
  let scanner = null;

  // ======= APIï¼ˆå…±é€šï¼‰ =======
  async function api(payload){
  const res = await fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload),
  });

  if(!res.ok){
    throw new Error("HTTP " + res.status);
  }

  const text = await res.text();
  try { return JSON.parse(text); }
  catch { throw new Error("JSONã˜ã‚ƒãªã„: " + text.slice(0,120)); }
}
  // ======= ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹ï¼ˆJANå‘ã‘å®‰å®šï¼‰ =======
  async function startScan(){
    try{
      if (scanner) return; // äºŒé‡èµ·å‹•é˜²æ­¢

      scanner = new Html5Qrcode("reader");

      await scanner.start(
        { facingMode: "environment" },
        {
          fps: 6,
          qrbox: { width: 360, height: 140 },
          aspectRatio: 1.777,
          disableFlip: true,
          // ç«¯æœ«ã«ã‚ˆã£ã¦åŠ¹ãï¼ˆåŠ¹ã‹ãªãã¦ã‚‚å•é¡Œãªã—ï¼‰
          videoConstraints: {
            facingMode: "environment",
            width: { ideal: 1280 },
            height: { ideal: 720 }
          }
        },
        (decodedText)=>{
          document.getElementById("input").value = decodedText;
          search().catch(()=>{});
          stopScan().catch(()=>{});
        }
      );

    }catch(e){
      alert("ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹ã‚¨ãƒ©ãƒ¼: " + (e && e.message ? e.message : String(e)));
      scanner = null;
    }
  }

  async function stopScan(){
    try{
      if (!scanner) return;
      await scanner.stop();
      await scanner.clear();
    } catch(e) {
      // stopã¯å¤±æ•—ã—ã¦ã‚‚OK
    } finally {
      scanner = null;
    }
  }

  // ======= æ¤œç´¢ =======
  async function search(){
  try{
    document.getElementById("result").innerText = "ğŸ”„ æ¤œç´¢ä¸­...";

    const q = document.getElementById("input").value.trim();
    if(!q){
      currentProduct = null;
      document.getElementById("result").innerText = "";
      return;
    }

    const res = await api({ action:"searchProduct", query:q });

    if(res && res.found){
      currentProduct = res;
      document.getElementById("result").innerText = `âœ… å•†å“: ${res.name}ï¼ˆ${res.id}ï¼‰`;
    } else {
      currentProduct = null;
      document.getElementById("result").innerText = "âŒ å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“";
    }

  }catch(e){
    document.getElementById("result").innerText = "âŒ ã‚¨ãƒ©ãƒ¼: " + e.message;
  }
}

  // ======= ä»•å…¥/å£²ä¸Š ç™»éŒ² =======
  async function registerTx(type){
    if(!currentProduct){
      alert("å…ˆã«å•†å“ã‚’æ¤œç´¢ã—ã¦ãã ã•ã„");
      return;
    }
    const qty = Number(document.getElementById("qty").value) || 0;
    if(qty <= 0){
      alert("æ•°é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      return;
    }

    const action = (type === "ä»•å…¥ã‚Œ") ? "addBuy" : "addSale";
    const res = await api({ action, productId: currentProduct.id, qty });

    alert(res && res.message ? res.message : "ç™»éŒ²ã—ã¾ã—ãŸ");

    // ã‚¯ãƒªã‚¢
    document.getElementById("qty").value = 1;
    document.getElementById("input").value = "";
    document.getElementById("result").innerText = "";
    currentProduct = null;
  }

  // ======= æ‰‹å‹•ç™»éŒ²ã®é–‹é–‰ =======
  function toggleManual(){
    const box = document.getElementById("manualBox");
    box.style.display = (box.style.display === "none") ? "block" : "none";
  }

  // ======= æ–°è¦è¿½åŠ  =======
  async function addNew(){
    const name = document.getElementById("newName").value.trim();
    const jan  = document.getElementById("newJan").value.trim();
    const cost = Number(document.getElementById("newCost").value) || 0;

    if(!name){
      alert("å•†å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      return;
    }

    const res = await api({ action:"addNewProduct", name, jan, cost });

    if(res && res.ok){
      document.getElementById("addResult").innerText = `âœ… è¿½åŠ ã—ã¾ã—ãŸ: ${res.name}ï¼ˆ${res.id}ï¼‰`;
      currentProduct = { id: res.id, name: res.name };
      document.getElementById("result").innerText = `âœ… å•†å“: ${res.name}ï¼ˆ${res.id}ï¼‰`;

      // å…¥åŠ›ã‚¯ãƒªã‚¢
      document.getElementById("newName").value = "";
      document.getElementById("newJan").value = "";
      document.getElementById("newCost").value = "";
      toggleManual();
    } else {
      document.getElementById("addResult").innerText = "âš  " + (res && res.message ? res.message : "è¿½åŠ ã§ãã¾ã›ã‚“ã§ã—ãŸ");
    }
  }

  // å¿µã®ãŸã‚ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ã¶ã‚‰ä¸‹ã’ã‚‹ï¼ˆiPhone Safariã§å®‰å®šï¼‰
  window.startScan = startScan;
  window.stopScan = stopScan;
  window.search = search;
  window.registerTx = registerTx;
  window.toggleManual = toggleManual;
  window.addNew = addNew;
</script>

</body>
</html>
