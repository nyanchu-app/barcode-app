<!DOCTYPE html>
<html lang="ja">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    body{
      font-family: Arial, sans-serif;
      padding: 20px;
      margin: 0;
      text-align: center;
      background: #f5f5f5;
    }
    input, button{
      width: 100%;
      padding: 14px;
      font-size: 16px;
      margin-top: 10px;
      box-sizing: border-box;
      border-radius: 10px;
      border: 1px solid #ddd;
    }
    button{
      background: #2e7d32;
      color: white;
      border: none;
      border-radius: 10px;
    }
    .subbtn{ background:#1565c0; }
    .danger{ background:#c62828; }
    .box{
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid #ddd;
    }
    #reader{
      width: 100%;
      max-width: 460px;
      margin: 12px auto;
      border-radius: 12px;
      overflow: hidden;
      background: #000;
    }
    .small{
      font-size: 13px;
      color: #666;
      margin-top: 6px;
    }
    #candidates{
      margin-top: 14px;
      text-align: left;
    }
    .cand{
      background: #fff;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 12px;
      margin-top: 10px;
    }
    .cand .name{
      font-size: 16px;
      font-weight: bold;
    }
    .cand .meta{
      font-size: 12px;
      color: #666;
      margin-top: 4px;
      line-height: 1.4;
      word-break: break-all;
    }
    .cand button{
      margin-top: 10px;
      background: #1565c0;
      border: none;
      color: #fff;
      border-radius: 10px;
      padding: 10px;
      width: 100%;
    }
    #result{
      margin-top: 12px;
      font-weight: bold;
    }
  </style>
</head>

<body>

<h2>ğŸ“¦ å•†å“ç™»éŒ²</h2>

<button class="subbtn" onclick="startScan()">ğŸ“· ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹</button>
<button class="danger" onclick="stopScan()">â›” ã‚¹ã‚­ãƒ£ãƒ³åœæ­¢</button>
<div class="small">â€» ã†ã¾ãèª­ã‚ãªã„æ™‚ã¯ã€Œã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆâ†’URLèµ·å‹•ã€ã§é‹ç”¨ãŒå®‰å®šã—ã¾ã™</div>
<div id="reader"></div>

<input id="input" placeholder="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰(JAN) or å•†å“åã§æ¤œç´¢">
<input id="qty" type="number" value="1" min="1">

<button onclick="search()">æ¤œç´¢</button>
<button onclick="registerTx('ä»•å…¥ã‚Œ')">ä»•å…¥ã‚Œ</button>
<button onclick="registerTx('å£²ä¸Š')">å£²ä¸Š</button>

<p id="result"></p>
<div id="candidates"></div>

<button onclick="toggleManual()">â• æ‰‹å‹•ã§å•†å“ç™»éŒ²</button>

<div id="manualBox" class="box" style="display:none;">
  <h3>æ–°è¦å•†å“ç™»éŒ²</h3>

  <input id="newName" placeholder="å•†å“åï¼ˆä¾‹ï¼šã„ã¡ã”å¤§ç¦ï¼‰">
  <input id="newJan" placeholder="JANï¼ˆã‚ã‚Œã°ï¼‰">
  <input id="newCost" type="number" inputmode="decimal" placeholder="ä»•å…¥å˜ä¾¡ï¼ˆä¾‹ï¼š120ï¼‰">

  <button class="subbtn" onclick="addNew()">å•†å“ãƒã‚¹ã‚¿ã«è¿½åŠ </button>
  <p id="addResult"></p>
</div>


<script>
  // =========================
  // â˜…ã“ã“ã ã‘å¿…ãšè¨­å®š
  // =========================
  const API_URL = "https://script.google.com/macros/s/AKfycbxUY_9TR9Wu-urdCBvEv2aKQza2mPlVHOcZA6h5iHqTUDEtiUG5qYjTooMkAy2S0npr/exec";

  // =========================
  // çŠ¶æ…‹
  // =========================
  let currentProduct = null;     // {id, name}
  let scanner = null;            // Html5Qrcode instance
  let __candidates = [];         // GASã‹ã‚‰è¿”ã‚‹å€™è£œé…åˆ—

  // =========================
  // JSONPï¼ˆGitHub Pages â†’ GASï¼‰
  // =========================
  function apiJsonp(params){
    return new Promise((resolve, reject) => {
      const cb = "cb_" + Date.now() + "_" + Math.floor(Math.random() * 1e6);
      const qs = new URLSearchParams({ ...params, callback: cb, t: Date.now() }).toString();
      const url = API_URL + "?" + qs;

      const s = document.createElement("script");

      window[cb] = (res) => {
        cleanup();
        resolve(res);
      };

      s.onerror = () => {
        cleanup();
        reject(new Error("Load failed"));
      };

      s.src = url;
      document.body.appendChild(s);

      function cleanup(){
        try{ delete window[cb]; }catch(e){}
        try{ s.remove(); }catch(e){}
      }
    });
  }

  function setText(id, text){
    document.getElementById(id).innerText = text || "";
  }

  function clearCandidates(){
    __candidates = [];
    document.getElementById("candidates").innerHTML = "";
  }

  // =========================
  // æ¤œç´¢ï¼ˆå€™è£œãƒªã‚¹ãƒˆå¯¾å¿œï¼‰
  // =========================
  async function search(){
    try{
      const q = document.getElementById("input").value.trim();

      clearCandidates();
      setText("addResult", "");

      if(!q){
        currentProduct = null;
        setText("result", "");
        return;
      }

      setText("result", "ğŸ” æ¤œç´¢ä¸­...");

      const res = await apiJsonp({ action:"searchProduct", query:q });

      if(!res || !res.ok){
        currentProduct = null;
        setText("result", "âŒ ã‚¨ãƒ©ãƒ¼: " + (res && res.message ? res.message : "ä¸æ˜"));
        return;
      }

      const list = Array.isArray(res.results) ? res.results : [];

      if(list.length === 0){
        currentProduct = null;
        setText("result", "âŒ å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆæ‰‹å‹•ç™»éŒ²ã§ãã¾ã™ï¼‰");

        // å•†å“ãªã— â†’ æ‰‹å‹•ç™»éŒ²ã‚’è‡ªå‹•ã§é–‹ãï¼†JANã‚’è‡ªå‹•å…¥åŠ›
        document.getElementById("manualBox").style.display = "block";
        document.getElementById("newJan").value = q;
        return;
      }

      if(list.length === 1){
        selectCandidate(list[0]);
        return;
      }

      // è¤‡æ•°å€™è£œ â†’ ãƒªã‚¹ãƒˆè¡¨ç¤º
      setText("result", "å€™è£œã‹ã‚‰é¸ã‚“ã§ãã ã•ã„ğŸ‘‡");
      __candidates = list;

      const html = list.map((item, idx) => {
        const meta = [
          item.id ? `ID: ${escapeHtml_(item.id)}` : "",
          item.jan ? `JAN: ${escapeHtml_(item.jan)}` : ""
        ].filter(Boolean).join(" / ");

        return `
          <div class="cand">
            <div class="name">${escapeHtml_(item.name || "")}</div>
            <div class="meta">${meta}</div>
            <button onclick="pickCandidate(${idx})">ã“ã‚Œã«ã™ã‚‹</button>
          </div>
        `;
      }).join("");

      document.getElementById("candidates").innerHTML = html;

    }catch(e){
      currentProduct = null;
      setText("result", "âŒ ã‚¨ãƒ©ãƒ¼: " + (e && e.message ? e.message : String(e)));
    }
  }

  function pickCandidate(i){
    const item = __candidates[i];
    if(item) selectCandidate(item);
  }

  function selectCandidate(item){
    currentProduct = { id: item.id, name: item.name };
    clearCandidates();
    setText("result", `âœ… é¸æŠ: ${item.name}ï¼ˆ${item.id}ï¼‰`);
  }

  // =========================
  // ä»•å…¥ / å£²ä¸Š
  // =========================
  async function registerTx(type){
    try{
      if(!currentProduct){
        alert("å…ˆã«å•†å“ã‚’æ¤œç´¢ã—ã¦é¸æŠã—ã¦ãã ã•ã„");
        return;
      }

      const qty = Number(document.getElementById("qty").value) || 0;
      if(qty <= 0){
        alert("æ•°é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
      }

      const action = (type === "ä»•å…¥ã‚Œ") ? "addBuy" : "addSale";

      const res = await apiJsonp({
        action,
        productId: currentProduct.id,
        qty
      });

      alert((res && res.message) ? res.message : "ç™»éŒ²ã—ã¾ã—ãŸ");

      // å¿…è¦ãªã‚‰å…¥åŠ›ã ã‘ã‚¯ãƒªã‚¢ï¼ˆé¸æŠã¯æ®‹ã™é‹ç”¨ã‚‚ã‚¢ãƒªï¼‰
      document.getElementById("qty").value = 1;
      // document.getElementById("input").value = "";
      // setText("result", "");
      // currentProduct = null;

    }catch(e){
      alert("ç™»éŒ²ã‚¨ãƒ©ãƒ¼: " + (e && e.message ? e.message : String(e)));
    }
  }

  // =========================
  // æ‰‹å‹•ç™»éŒ²ã®é–‹é–‰
  // =========================
  function toggleManual(){
    const box = document.getElementById("manualBox");
    box.style.display = (box.style.display === "none") ? "block" : "none";
  }

  // =========================
  // æ–°è¦è¿½åŠ ï¼ˆå®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‹è¿½åŠ å¾Œã«è‡ªå‹•é¸æŠï¼‰
  // =========================
  async function addNew(){
    try{
      const name = document.getElementById("newName").value.trim();
      const jan  = document.getElementById("newJan").value.trim();
      const cost = Number(document.getElementById("newCost").value) || 0;

      if(!name){
        alert("å•†å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
      }

      const res = await apiJsonp({
        action:"addNewProduct",
        name,
        jan,
        cost
      });

      // âœ… å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆalert + ç”»é¢è¡¨ç¤ºï¼‰
      const msg = (res && res.message) ? res.message : "å‡¦ç†ã—ã¾ã—ãŸ";
      alert(msg);
      setText("addResult", msg);

      if(res && res.ok){
        // âœ… è¿½åŠ ã—ãŸIDã‚’ input ã«å…¥ã‚Œã¦æ¤œç´¢â†’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
        document.getElementById("input").value = res.id;
        await search();

        // âœ… å…¥åŠ›ã‚¯ãƒªã‚¢
        document.getElementById("newName").value = "";
        document.getElementById("newJan").value = "";
        document.getElementById("newCost").value = "";

        // å¥½ã¿ï¼šé–‰ã˜ã‚‹ãªã‚‰ON
        // document.getElementById("manualBox").style.display = "none";
      }

    }catch(e){
      alert("è¿½åŠ ã‚¨ãƒ©ãƒ¼: " + (e && e.message ? e.message : String(e)));
    }
  }

  // =========================
  // ã‚«ãƒ¡ãƒ©ï¼ˆè£œåŠ©ï¼šèª­ã‚ãŸã‚‰æ¤œç´¢ã—ã¦åœæ­¢ï¼‰
  // =========================
  async function startScan(){
    try{
      if(scanner) return;

      setText("result", "ğŸ“· èµ·å‹•ä¸­...");

      scanner = new Html5Qrcode("reader");

      await scanner.start(
        { facingMode: "environment" },
        {
          fps: 10,
          qrbox: { width: 320, height: 160 },
          aspectRatio: 1.777,
          disableFlip: true
        },
        async (decodedText) => {
          document.getElementById("input").value = decodedText;
          await stopScan();
          await search();
        }
      );

      setText("result", "âœ… èª­ã¿å–ã‚Šå¾…æ©Ÿä¸­");

    }catch(e){
      alert("ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹ã‚¨ãƒ©ãƒ¼: " + (e && e.message ? e.message : String(e)));
      scanner = null;
      setText("result", "");
    }
  }

  async function stopScan(){
    try{
      if(!scanner) return;
      await scanner.stop();
      await scanner.clear();
    }catch(e){
      // stopå¤±æ•—ã—ã¦ã‚‚OK
    }finally{
      scanner = null;
    }
  }

  function escapeHtml_(s){
    return String(s || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // =========================
  // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ ?jan= ã§è‡ªå‹•æ¤œç´¢ï¼ˆã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆé‹ç”¨ç”¨ï¼‰
  // =========================
  window.addEventListener("load", () => {
    const p = new URLSearchParams(location.search);
    const jan = p.get("jan");
    if(jan){
      document.getElementById("input").value = jan;
      setTimeout(() => { search(); }, 200);
    }
  });

  // iPhone Safariã§onclickå®‰å®šç”¨
  window.startScan = startScan;
  window.stopScan = stopScan;
  window.search = search;
  window.registerTx = registerTx;
  window.toggleManual = toggleManual;
  window.addNew = addNew;
  window.pickCandidate = pickCandidate;
  window.selectCandidate = selectCandidate;
</script>

</body>
</html>
