<!DOCTYPE html>
<html lang="ja">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    body{
      font-family: Arial, sans-serif;
      padding: 20px;
      margin: 0;
      text-align: center;
      background: #f5f5f5;
    }
    input, button{
      width: 100%;
      padding: 14px;
      font-size: 16px;
      margin-top: 10px;
      box-sizing: border-box;
      border-radius: 10px;
      border: 1px solid #ddd;
    }
    button{
      background: #2e7d32;
      color: white;
      border: none;
      border-radius: 10px;
    }
    .subbtn{ background:#1565c0; }
    .danger{ background:#c62828; }

    #reader{
      width: 100%;
      max-width: 460px;
      margin: 12px auto;
      border-radius: 12px;
      overflow: hidden;
      background: #000;
    }
    .small{
      font-size: 13px;
      color: #666;
      margin-top: 6px;
      line-height: 1.4;
    }

    #result{
      margin-top: 12px;
      font-weight: bold;
      white-space: pre-line;
    }

    #candidates{
      margin-top: 14px;
      text-align: left;
    }
    .cand{
      background: #fff;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 12px;
      margin-top: 10px;
    }
    .cand .name{
      font-size: 16px;
      font-weight: bold;
    }
    .cand .meta{
      font-size: 12px;
      color: #666;
      margin-top: 4px;
      line-height: 1.4;
      word-break: break-all;
    }
    .cand button{
      margin-top: 10px;
      background: #1565c0;
      border: none;
      color: #fff;
      border-radius: 10px;
      padding: 10px;
      width: 100%;
    }

    .box{
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid #ddd;
    }

    /* UNDO */
    #undoBox{
      display:none;
      margin-top: 12px;
      padding: 10px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 12px;
      text-align: left;
    }
    #undoBox .small{
      margin-top: 8px;
    }
  </style>
</head>

<body>

<h2>ğŸ“¦ å•†å“ç™»éŒ²</h2>

<button class="subbtn" onclick="startScan()">ğŸ“· ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹</button>
<button class="danger" onclick="stopScan()">â›” ã‚¹ã‚­ãƒ£ãƒ³åœæ­¢</button>
<div class="small">â€» èª­ã‚ãªã„æ™‚ã¯ã€ŒiPhoneã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆâ†’URLèµ·å‹•ï¼ˆ?jan=ï¼‰ã€é‹ç”¨ãŒå®‰å®šã§ã™</div>
<div id="reader"></div>

<input id="input" placeholder="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰(JAN) or å•†å“åã§æ¤œç´¢">
<input id="qty" type="number" value="1" min="1">

<button onclick="search()">æ¤œç´¢</button>
<button onclick="registerTx('ä»•å…¥ã‚Œ')">ä»•å…¥ã‚Œ</button>
<button onclick="registerTx('å£²ä¸Š')">å£²ä¸Š</button>

<p id="result"></p>

<!-- âœ… UNDO UI -->
<div id="undoBox">
  <button class="danger" onclick="undoLast()">â†© ç›´å‰ã®ç™»éŒ²ã‚’å–ã‚Šæ¶ˆã™ï¼ˆ30ç§’ä»¥å†…ï¼‰</button>
  <div class="small" id="undoMsg"></div>
</div>

<div id="candidates"></div>

<button onclick="toggleManual()">â• æ‰‹å‹•ã§å•†å“ç™»éŒ²</button>

<div id="manualBox" class="box" style="display:none;">
  <h3>æ–°è¦å•†å“ç™»éŒ²</h3>

  <input id="newName" placeholder="å•†å“åï¼ˆä¾‹ï¼šã„ã¡ã”å¤§ç¦ï¼‰">
  <input id="newJan" placeholder="JANï¼ˆã‚ã‚Œã°ï¼‰">

  <input id="newCost"  type="number" inputmode="decimal" placeholder="ä»•å…¥å˜ä¾¡ï¼ˆä¾‹ï¼š120ï¼‰">
  <input id="newPrice" type="number" inputmode="decimal" placeholder="è²©å£²å˜ä¾¡ï¼ˆæœªå…¥åŠ›ãªã‚‰è‡ªå‹•ä»®å…¥åŠ›ï¼‰">
  <input id="newSafe"  type="number" inputmode="numeric" placeholder="å®‰å…¨åœ¨åº«ï¼ˆä¾‹ï¼š10ï¼‰">

  <button class="subbtn" onclick="addNew()">å•†å“ãƒã‚¹ã‚¿ã«è¿½åŠ </button>
  <p id="addResult"></p>
</div>

<script>
  // =========================
  // â˜…è¨­å®š
  // =========================
  const API_URL = "https://script.google.com/macros/s/AKfycbxUY_9TR9Wu-urdCBvEv2aKQza2mPlVHOcZA6h5iHqTUDEtiUG5qYjTooMkAy2S0npr/exec";

  // è²©å£²å˜ä¾¡ãŒæœªå…¥åŠ›ãªã‚‰ã€Œä»•å…¥Ã—å€ç‡ã€ã§ä»®å…¥åŠ›ï¼ˆä¾‹ï¼š2å€ï¼‰
  const DEFAULT_PRICE_MULT = 2.0;

  // UNDOçŒ¶äºˆï¼ˆmsï¼‰
  const UNDO_WINDOW_MS = 30000;

  // =========================
  // çŠ¶æ…‹
  // =========================
  let currentProduct = null;      // {id, name}
  let scanner = null;             // Html5Qrcode instance
  let __candidates = [];          // searchçµæœå€™è£œ

  // UNDOç”¨ï¼ˆæ¬¡ã®GASæ”¹ä¿®ã§ row/token ãŒè¿”ã‚‹ã¨å®Œæˆï¼‰
  let lastTx = null;              // {sheet,row,token,at,message}
  let undoTimer = null;

  // =========================
  // DOM helper
  // =========================
  const $ = (id) => document.getElementById(id);

  function setText(id, text){
    $(id).innerText = text || "";
  }

  function clearCandidates(){
    __candidates = [];
    $("candidates").innerHTML = "";
  }

  // =========================
  // åˆæœŸçŠ¶æ…‹ã«æˆ»ã™ï¼ˆResetï¼‰
  // =========================
  function resetUI(){
    currentProduct = null;

    $("input").value = "";
    $("qty").value = 1;

    setText("result", "");
    setText("addResult", "");

    clearCandidates();

    // æ‰‹å‹•æ¬„ã‚’é–‰ã˜ã¦å…¥åŠ›ã‚‚æ¶ˆã™
    $("manualBox").style.display = "none";
    $("newName").value = "";
    $("newJan").value = "";
    $("newCost").value = "";
    $("newPrice").value = "";
    $("newSafe").value = "";
  }

  // =========================
  // UNDO è¡¨ç¤º/ã‚¿ã‚¤ãƒãƒ¼
  // =========================
  function showUndo(message){
    $("undoBox").style.display = "block";
    setText("undoMsg", message + "\nâ€»30ç§’ä»¥å†…ãªã‚‰å–ã‚Šæ¶ˆã›ã¾ã™");

    if(undoTimer) clearTimeout(undoTimer);
    undoTimer = setTimeout(() => {
      $("undoBox").style.display = "none";
      lastTx = null;
    }, UNDO_WINDOW_MS);
  }

  function hideUndo(){
    $("undoBox").style.display = "none";
    if(undoTimer) clearTimeout(undoTimer);
    undoTimer = null;
  }

  // =========================
  // JSONPï¼ˆGitHub Pages â†’ GASï¼‰
  // =========================
  function apiJsonp(params){
    return new Promise((resolve, reject) => {
      const cb = "cb_" + Date.now() + "_" + Math.floor(Math.random() * 1e6);
      const qs = new URLSearchParams({ ...params, callback: cb, t: Date.now() }).toString();
      const url = API_URL + "?" + qs;

      const s = document.createElement("script");

      window[cb] = (res) => {
        cleanup();
        resolve(res);
      };

      s.onerror = () => {
        cleanup();
        reject(new Error("Load failed"));
      };

      s.src = url;
      document.body.appendChild(s);

      function cleanup(){
        try{ delete window[cb]; }catch(e){}
        try{ s.remove(); }catch(e){}
      }
    });
  }

  function escapeHtml_(s){
    return String(s || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // =========================
  // æ¤œç´¢ï¼ˆå€™è£œãƒªã‚¹ãƒˆï¼‰
  // =========================
  async function search(){
    try{
      const q = $("input").value.trim();

      clearCandidates();
      setText("addResult", "");

      if(!q){
        currentProduct = null;
        setText("result", "");
        return;
      }

      setText("result", "ğŸ” æ¤œç´¢ä¸­...");

      const res = await apiJsonp({ action:"searchProduct", query:q });

      if(!res || !res.ok){
        currentProduct = null;
        setText("result", "âŒ ã‚¨ãƒ©ãƒ¼: " + (res && res.message ? res.message : "ä¸æ˜"));
        return;
      }

      const list = Array.isArray(res.results) ? res.results : [];

      if(list.length === 0){
        currentProduct = null;
        setText("result", "âŒ å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆæ‰‹å‹•ç™»éŒ²ã§ãã¾ã™ï¼‰");

        // å•†å“ãªã— â†’ æ‰‹å‹•ç™»éŒ²ã‚’è‡ªå‹•ã§é–‹ã & JANã‚’è‡ªå‹•å…¥åŠ›
        $("manualBox").style.display = "block";
        $("newJan").value = q;
        return;
      }

      if(list.length === 1){
        selectCandidate(list[0]);
        return;
      }

      setText("result", "å€™è£œã‹ã‚‰é¸ã‚“ã§ãã ã•ã„ğŸ‘‡");
      __candidates = list;

      const html = list.map((item, idx) => {
        const meta = [
          item.id ? `ID: ${escapeHtml_(item.id)}` : "",
          item.jan ? `JAN: ${escapeHtml_(item.jan)}` : ""
        ].filter(Boolean).join(" / ");

        return `
          <div class="cand">
            <div class="name">${escapeHtml_(item.name || "")}</div>
            <div class="meta">${meta}</div>
            <button onclick="pickCandidate(${idx})">ã“ã‚Œã«ã™ã‚‹</button>
          </div>
        `;
      }).join("");

      $("candidates").innerHTML = html;

    }catch(e){
      currentProduct = null;
      setText("result", "âŒ ã‚¨ãƒ©ãƒ¼: " + (e && e.message ? e.message : String(e)));
    }
  }

  function pickCandidate(i){
    const item = __candidates[i];
    if(item) selectCandidate(item);
  }

  function selectCandidate(item){
    currentProduct = { id: item.id, name: item.name };
    clearCandidates();
    setText("result", `âœ… é¸æŠ: ${item.name}ï¼ˆ${item.id}ï¼‰`);
  }

  // =========================
  // ä»•å…¥ / å£²ä¸Šï¼ˆæˆåŠŸã—ãŸã‚‰åˆæœŸçŠ¶æ…‹ã¸ï¼‰
  // =========================
  async function registerTx(type){
    try{
      if(!currentProduct){
        alert("å…ˆã«å•†å“ã‚’æ¤œç´¢ã—ã¦é¸æŠã—ã¦ãã ã•ã„");
        return;
      }

      const qty = Number($("qty").value) || 0;
      if(qty <= 0){
        alert("æ•°é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
      }

      const action = (type === "ä»•å…¥ã‚Œ") ? "addBuy" : "addSale";
      const res = await apiJsonp({ action, productId: currentProduct.id, qty });

      const msg = (res && res.message) ? res.message : "ç™»éŒ²ã—ã¾ã—ãŸ";
      alert(msg);

      // âœ… UNDOç”¨ã«ä¿å­˜ï¼ˆâ€»æ¬¡ã®GASæ”¹ä¿®ã§ row/token ãŒè¿”ã‚‹ã¨å®Œæˆï¼‰
      // è¿”ã£ã¦ã“ãªã„å ´åˆã§ã‚‚ã¨ã‚Šã‚ãˆãšãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã ã‘è¡¨ç¤ºã—ã¦ãŠã
      lastTx = {
        sheet: res && res.sheet ? res.sheet : null,
        row:   res && res.row ? Number(res.row) : null,
        token: res && res.token ? res.token : null,
        at: Date.now(),
        message: msg
      };

      showUndo(msg);

      // âœ… åˆæœŸçŠ¶æ…‹ã«æˆ»ã™ï¼ˆã“ã‚ŒãŒã‚ãªãŸã®ç†æƒ³ã®å‹•ãï¼‰
      resetUI();

    }catch(e){
      alert("ç™»éŒ²ã‚¨ãƒ©ãƒ¼: " + (e && e.message ? e.message : String(e)));
    }
  }

  // =========================
  // UNDOï¼ˆGASå´ãŒ row/token ã‚’è¿”ã—ãŸã‚‰å®Œæˆï¼‰
  // =========================
  async function undoLast(){
    try{
      if(!lastTx){
        alert("å–ã‚Šæ¶ˆã›ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
        return;
      }

      // ã¾ã GASãŒè¡Œç•ªå·ã‚’è¿”ã—ã¦ãªã„å ´åˆ
      if(!lastTx.sheet || !lastTx.row || !lastTx.token){
        alert("UNDOã¯æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆGASæ”¹ä¿®ï¼šè¡Œç•ªå·è¿”å´ï¼‰ãŒçµ‚ã‚ã‚‹ã¨ä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ğŸ™");
        return;
      }

      const res = await apiJsonp({
        action: "undo",
        sheet: lastTx.sheet,
        row: String(lastTx.row),
        token: lastTx.token
      });

      alert((res && res.message) ? res.message : "å–ã‚Šæ¶ˆã—ã¾ã—ãŸ");
      hideUndo();
      lastTx = null;

    }catch(e){
      alert("UNDOã‚¨ãƒ©ãƒ¼: " + (e && e.message ? e.message : String(e)));
    }
  }

  // =========================
  // æ‰‹å‹•ç™»éŒ²ã®é–‹é–‰
  // =========================
  function toggleManual(){
    $("manualBox").style.display = ($("manualBox").style.display === "none") ? "block" : "none";
  }

  // =========================
  // æ–°è¦å•†å“è¿½åŠ ï¼ˆè²©å£²å˜ä¾¡ãŒæœªå…¥åŠ›ãªã‚‰ä»®å…¥åŠ›ï¼‰
  // è¿½åŠ æˆåŠŸå¾Œï¼šè‡ªå‹•é¸æŠ â†’ æ•°é‡å…¥åŠ› â†’ ä»•å…¥/å£²ä¸Š â†’ ç™»éŒ²æˆåŠŸã§åˆæœŸåŒ–
  // =========================
  async function addNew(){
    try{
      const name = $("newName").value.trim();
      const jan  = $("newJan").value.trim();
      const cost = Number($("newCost").value) || 0;
      let price  = Number($("newPrice").value) || 0;
      const safe = Number($("newSafe").value) || 0;

      if(!name){
        alert("å•†å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
      }

      // âœ… è²©å£²å˜ä¾¡ æœªå…¥åŠ›ãªã‚‰è‡ªå‹•ä»®å…¥åŠ›ï¼ˆä»•å…¥Ã—å€ç‡ï¼‰
      if(!price && cost > 0){
        price = Math.round(cost * DEFAULT_PRICE_MULT);
        $("newPrice").value = price; // ç”»é¢ã«ã‚‚åæ˜ 
      }

      const res = await apiJsonp({
        action:"addNewProduct",
        name, jan, cost, price, safe
      });

      const msg = (res && res.message) ? res.message : "å‡¦ç†ã—ã¾ã—ãŸ";

      // âœ… å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆalert + ç”»é¢è¡¨ç¤ºï¼‰
      alert(msg);
      setText("addResult", msg);

      if(res && res.ok){
        // âœ… è¿½åŠ å¾Œã«é¸æŠçŠ¶æ…‹ã«ã™ã‚‹ï¼ˆå³ä»•å…¥ã«è¡Œã‘ã‚‹ï¼‰
        $("input").value = res.id;
        await search();

        // æ‰‹å‹•å…¥åŠ›æ¬„ã¯ã‚¯ãƒªã‚¢ï¼ˆç®±ã¯é–‹ã„ãŸã¾ã¾ã§ã‚‚é–‰ã˜ã¦ã‚‚OKï¼‰
        $("newName").value = "";
        // newJan ã¯æ®‹ã™æ´¾ã‚‚ã„ã‚‹ã‘ã©ã€åŸºæœ¬ã¯æ¶ˆã™
        $("newJan").value = "";
        $("newCost").value = "";
        $("newPrice").value = "";
        $("newSafe").value = "";

        // å¥½ã¿ï¼šé–‰ã˜ã‚‹
        $("manualBox").style.display = "none";
      }

    }catch(e){
      alert("è¿½åŠ ã‚¨ãƒ©ãƒ¼: " + (e && e.message ? e.message : String(e)));
    }
  }

  // =========================
  // ã‚«ãƒ¡ãƒ©ï¼šèª­ã‚ãŸã‚‰æ¤œç´¢ã—ã¦åœæ­¢
  // =========================
  async function startScan(){
    try{
      if(scanner) return;

      setText("result", "ğŸ“· èµ·å‹•ä¸­...");
      scanner = new Html5Qrcode("reader");

      await scanner.start(
        { facingMode: "environment" },
        {
          fps: 10,
          qrbox: { width: 320, height: 160 },
          aspectRatio: 1.777,
          disableFlip: true
        },
        async (decodedText) => {
          $("input").value = decodedText;
          await stopScan();
          await search();
        }
      );

      setText("result", "âœ… èª­ã¿å–ã‚Šå¾…æ©Ÿä¸­");

    }catch(e){
      alert("ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹ã‚¨ãƒ©ãƒ¼: " + (e && e.message ? e.message : String(e)));
      scanner = null;
      setText("result", "");
    }
  }

  async function stopScan(){
    try{
      if(!scanner) return;
      await scanner.stop();
      await scanner.clear();
    }catch(e){
      // stopå¤±æ•—ã—ã¦ã‚‚OK
    }finally{
      scanner = null;
    }
  }

  // =========================
  // ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆé‹ç”¨ï¼š?jan= ã§è‡ªå‹•æ¤œç´¢
  // =========================
  window.addEventListener("load", () => {
    const p = new URLSearchParams(location.search);
    const jan = p.get("jan");
    if(jan){
      $("input").value = jan;
      setTimeout(() => { search(); }, 150);
    }
  });

  // iPhone Safariã§onclickå®‰å®šç”¨
  window.startScan = startScan;
  window.stopScan = stopScan;
  window.search = search;
  window.registerTx = registerTx;
  window.undoLast = undoLast;
  window.toggleManual = toggleManual;
  window.addNew = addNew;
  window.pickCandidate = pickCandidate;
  window.selectCandidate = selectCandidate;
  window.resetUI = resetUI;
</script>

</body>
</html>
